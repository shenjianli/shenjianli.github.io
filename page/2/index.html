<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>撑起头顶的天</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="撑起头顶的天">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="撑起头顶的天">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="撑起头顶的天">
  
  
    <link rel="icon" href="/img/mylogo.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/mylogo.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">申建利</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/shenjianli" title="github">github</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/ES6/" style="font-size: 10px;">ES6</a> <a href="/tags/Fresco/" style="font-size: 20px;">Fresco</a> <a href="/tags/Glide/" style="font-size: 10px;">Glide</a> <a href="/tags/Gradle/" style="font-size: 10px;">Gradle</a> <a href="/tags/Picasso/" style="font-size: 10px;">Picasso</a> <a href="/tags/ShenLib/" style="font-size: 10px;">ShenLib</a> <a href="/tags/cache/" style="font-size: 10px;">cache</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/picasso/" style="font-size: 10px;">picasso</a> <a href="/tags/test/" style="font-size: 10px;">test</a> <a href="/tags/分析/" style="font-size: 10px;">分析</a> <a href="/tags/面试/" style="font-size: 20px;">面试</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我是一名Android开发人员，欢迎各位光临各位访问指导！</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">申建利</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/mylogo.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">申建利</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/shenjianli" title="github">github</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-glide-example" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/06/glide-example/" class="article-date">
  	<time datetime="2016-06-06T02:53:03.000Z" itemprop="datePublished">2016-06-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/06/glide-example/">Glide使用实例</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Glide图片加载库的使用实例"><a href="#Glide图片加载库的使用实例" class="headerlink" title="Glide图片加载库的使用实例"></a>Glide图片加载库的使用实例</h2><p>在泰国举行的谷歌开发者论坛上，谷歌为我们介绍了一个名叫 Glide 的图片加载库，作者是bumptech。这个库被广泛的运用在google的开源项目中，包括2014年google I/O大会上发布的官方app。</p>
<p>Glide Github 地址：<br><a href="https://github.com/shenjianli/glide" target="_blank" rel="external">https://github.com/shenjianli/glide</a></p>
<p>Glide效果图：<br><img src="/image/glide_test.png" alt="glide"></p>
<p>其中代码结构和Picasso的使用实例十分相似，具体的代码逻辑与结构请参考<a href="http://shenjianli.github.io/2016/05/27/Picasso-Text-Example/" target="_blank" rel="external">Picasso使用实例</a></p>
<p>全面学习Glide可移步—&gt;<a href="http://mrfu.me/2016/02/27/Glide_Getting_Started/" target="_blank" rel="external">http://mrfu.me/2016/02/27/Glide_Getting_Started/</a></p>
<h2 id="总体设计及流程"><a href="#总体设计及流程" class="headerlink" title="总体设计及流程"></a>总体设计及流程</h2><p><img src="/image/overall-design-glide.jpg" alt="whole design"><br>上面是 Glide 的总体设计图。整个库分为 RequestManager(请求管理器)，Engine(数据获取引擎)、 Fetcher(数据获取器)、MemoryCache(内存缓存)、DiskLRUCache、Transformation(图片处理)、Encoder(本地缓存存储)、Registry(图片类型及解析器配置)、Target(目标) 等模块。</p>
<p>简单的讲就是 Glide 收到加载及显示资源的任务，创建 Request 并将它交给RequestManager，Request 启动 Engine 去数据源获取资源(通过 Fetcher )，获取到后 Transformation 处理后交给 Target。</p>
<p>Glide 依赖于 DiskLRUCache、GifDecoder 等开源库去完成本地缓存和 Gif 图片解码工作。</p>
<h2 id="Glide-优点"><a href="#Glide-优点" class="headerlink" title="Glide 优点"></a>Glide 优点</h2><p>(1) 图片缓存-&gt;媒体缓存<br>Glide 不仅是一个图片缓存，它支持 Gif、WebP、缩略图。甚至是 Video，所以更该当做一个媒体缓存。<br>(2) 支持优先级处理<br>(3) 与 Activity/Fragment 生命周期一致，支持 trimMemory<br>Glide 对每个 context 都保持一个 RequestManager，通过 FragmentTransaction 保持与 Activity/Fragment 生命周期一致，并且有对应的 trimMemory 接口实现可供调用。<br>(4) 支持 okhttp、Volley<br>Glide 默认通过 UrlConnection 获取数据，可以配合 okhttp 或是 Volley 使用。实际 ImageLoader、Picasso 也都支持 okhttp、Volley。<br>(5) 内存友好<br>① Glide 的内存缓存有个 active 的设计<br>从内存缓存中取数据时，不像一般的实现用 get，而是用 remove，再将这个缓存数据放到一个 value 为软引用的 activeResources map 中，并计数引用数，在图片加载完成后进行判断，如果引用计数为空则回收掉。<br>② 内存缓存更小图片<br>Glide 以 url、view_width、view_height、屏幕的分辨率等做为联合 key，将处理后的图片缓存在内存缓存中，而不是原始图片以节省大小<br>③ 与 Activity/Fragment 生命周期一致，支持 trimMemory<br>④ 图片默认使用默认 RGB_565 而不是 ARGB_888<br>虽然清晰度差些，但图片更小，也可配置到 ARGB_888。<br>其他：Glide 可以通过 signature 或不使用本地缓存支持 url 过期</p>
<h3 id="下面来说明一下存在的问题："><a href="#下面来说明一下存在的问题：" class="headerlink" title="下面来说明一下存在的问题："></a>下面来说明一下存在的问题：</h3><p>1.有的图片第一次加载的时候只显示占位图，第二次才显示正常的图片呢<br>如果你刚好使用了这个圆形Imageview库或者其他的一些自定义的圆形Imageview，而你又刚好设置了占位的话，那么，你就会遇到第一个问题。如何解决呢？<br>方案一: 不设置占位；<br>方案二：使用Glide的Transformation API自定义圆形Bitmap的转换。这里是一个已有的例子；<br>方案三：使用下面的代码加载图片：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Glide.with(mContext)</div><div class="line">    .load(url) </div><div class="line">    .placeholder(R.drawable.loading_spinner)</div><div class="line">    .into(new SimpleTarget&lt;Bitmap&gt;(width, height) &#123;</div><div class="line">        @Override </div><div class="line">        public void onResourceReady(Bitmap bitmap, GlideAnimation anim) &#123;</div><div class="line">            // setImageBitmap(bitmap) on CircleImageView </div><div class="line">        &#125; </div><div class="line">    &#125;;</div></pre></td></tr></table></figure></p>
<p>2.我总会得到类似You cannot start a load for a destroyed activity这样的异常呢<br>请记住一句话：不要再非主线程里面使用Glide加载图片，如果真的使用了，请把context参数换成getApplicationContext。</p>
<p>3.我不能给加载的图片setTag()呢<br>是因为你使用的姿势不对哦。如何为ImageView设置Tag呢？且听我细细道来。<br>方案一：使用setTag(int,object)方法设置tag,具体用法如下：<br>Java代码是酱紫的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Glide.with(context).load(urls.get(i).getUrl()).fitCenter().into(imageViewHolder.image);</div><div class="line">        imageViewHolder.image.setTag(R.id.image_tag, i);</div><div class="line">        imageViewHolder.image.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">                int position = (int) v.getTag(R.id.image_tag);</div><div class="line">                Toast.makeText(context, urls.get(position).getWho(), Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure></p>
<p>同时在values文件夹下新建ids.xml，添加</p>
<p><item name="image_tag" type="id"><br>大功告成!<br>方案二：从Glide的3.6.0之后，新添加了全局设置的方法。具体方法如下：<br>先实现GlideMoudle接口，全局设置ViewTaget的tagId:<br>public class MyGlideMoudle implements GlideModule{<br>    @Override<br>    public void applyOptions(Context context, GlideBuilder builder) {<br>        ViewTarget.setTagId(R.id.glide_tag_id);<br>    }</item></p>
<pre><code>@Override
public void registerComponents(Context context, Glide glide) {

}
</code></pre><p>}<br>同样，也需要在ids.xml下添加id</p>
<p><item name="glide_tag_id" type="id"><br>最后在AndroidManifest.xml文件里面添加</item></p>
<p><meta-data android:name="com.yourpackagename.MyGlideMoudle" android:value="GlideModule"><br>又可以愉快的玩耍了，嘻嘻`(∩_∩)′。<br>方案三：写一个继承自ImageViewTaget的类，复写它的get/setRequest方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Glide.with(context).load(urls.get(i).getUrl()).fitCenter().into(new ImageViewTarget&lt;GlideDrawable&gt;(imageViewHolder.image) &#123;</div><div class="line">            @Override</div><div class="line">            protected void setResource(GlideDrawable resource) &#123;</div><div class="line">                imageViewHolder.image.setImageDrawable(resource);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public void setRequest(Request request) &#123;</div><div class="line">                imageViewHolder.image.setTag(i);</div><div class="line">                imageViewHolder.image.setTag(R.id.glide_tag_id,request);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public Request getRequest() &#123;</div><div class="line">                return (Request) imageViewHolder.image.getTag(R.id.glide_tag_id);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        imageViewHolder.image.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onClick(View v) &#123;</div><div class="line">                int position = (int) v.getTag();</div><div class="line">                Toast.makeText(context, urls.get(position).getWho(), Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure></meta-data></p>
<h2 id="Glide使用技巧"><a href="#Glide使用技巧" class="headerlink" title="Glide使用技巧"></a>Glide使用技巧</h2><p>1.Glide.with(context).resumeRequests()和 Glide.with(context).pauseRequests()<br>当列表在滑动的时候，调用pauseRequests()取消请求，滑动停止时，调用resumeRequests()恢复请求。这样是不是会好些呢？<br>2.Glide.clear()<br>当你想清除掉所有的图片加载请求时，这个方法可以帮助到你。<br>3.ListPreloader<br>如果你想让列表预加载的话，不妨试一下ListPreloader这个类。</p>
<h2 id="一些基于Glide的库"><a href="#一些基于Glide的库" class="headerlink" title="一些基于Glide的库"></a>一些基于Glide的库</h2><p>1.glide-transformations（<a href="https://github.com/wasabeef/glide-transformations" target="_blank" rel="external">https://github.com/wasabeef/glide-transformations</a>）<br>一个基于Glide的transformation库，拥有裁剪，着色，模糊，滤镜等多种转换效果，赞的不行不行的~~<br>2.GlidePalette <a href="https://github.com/florent37/GlidePalette" target="_blank" rel="external">https://github.com/florent37/GlidePalette</a><br>一个可以在Glide加载时很方便使用Palette的库。</p>
<h2 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h2><p><a href="https://github.com/shenjianli/GlideTest" target="_blank" rel="external">Glide源码</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Glide/">Glide</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-es6-promise" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/03/es6-promise/" class="article-date">
  	<time datetime="2016-06-03T07:04:52.000Z" itemprop="datePublished">2016-06-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/03/es6-promise/">ES6 Promise</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Promise的含义<br>所谓Promise，就是一个对象，用来传递异步操作的消息。它代表了**某个未来才知道结果的事件（通常是一个异步操作），并且这个事件提供统一的API，可供进一步处理。</p>
<p>Promise对象有以下两个特点：<br>（1）对象的状态不受外界影响。Promise对象代表一个异步操作，有三种状态：Pending(进行中)，Resolved(已完成，又称Fulfiled)和Rejected(已失败)。只有异步操作的结果，可以决定当前是哪一种状态，任何其他操作都无法改变这个状态。这也是Promise这个名字的由来，这的英语意思就是“承诺”，表示其他手段无法改变。</p>
<p>（2）一旦状态改变，就不会再变，任何时候都可以得到这个结果。Promise对象的状态改变，只有两种可能：从Pending变为Resolved和Pending变为Rejected。只要这两种情况发生，状态就凝固了，不会再变了，会一直操持这个结果。当改变已经发生了，你再对Promise对象添加回调函数，也会立即得到这个结果。这与事件（Event）完全不同，事件的特点是，如果你错过了它，再去监听，是得不到结果的。</p>
<p>有了Promise对象，就可以将异步操作以同步操作的流程表达出来，避免了层层嵌套的回调函数。此外，Promise对象提供统一的接口，使得控制异步操作更加容易。</p>
<h3 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h3><p>1.无法取消Promise，一旦新建它就会立即执行，无法中途取消<br>2.不设置回调函数，Promise内部抛出错误，不会反应到外部。<br>3.当处于Pending状态时，无法得知目前进展到哪个阶段（刚刚开始还是完成）。</p>
<p>如果某些事件不断地反复发生，一般来说，使用stream模式是比部署Promise更好的选择。</p>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>Promise对象是一个构造函数，用来生成Promise实例，创建Promise实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">var promise = new Promise(function(resolve,reject)&#123;</div><div class="line">	//some code</div><div class="line">	if(异步操作成功）&#123;</div><div class="line">		resolve(value);</div><div class="line">    &#125;</div><div class="line">	else&#123;</div><div class="line">		reject(error);</div><div class="line">    &#125;    </div><div class="line">&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>Promise构造函数接受一个函数作为参数，该函数的两个参数分别是resolve和reject。它们是两个函数，<br>由JavaScript引擎提供，不用自己部署。<br>resolve函数的作用是，将Promise对象的状态从“未完成”变为“成功”（即从Pending变为<br>Resolved），在异步操作成功时调用，并将异步操作的结果，作为参数传递出去；reject函数的作用是，<br>将Promise对象的状态从“未完成”变为“失败”（即从Pending变为Rejected），在异步操作失败时调<br>用，并将异步操作报出的错误，作为参数传递出去。<br>Promise实例生成以后，可以用then方法分别指定Resolved状态和Reject状态的回调函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">promise.then(function(value) &#123;</div><div class="line">  // success</div><div class="line">&#125;, function(value) &#123;</div><div class="line">  // failure</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>then方法可以接受两个回调函数作为参数。第一个回调函数是Promise对象的状态变为Resolved时调用，<br>第二个回调函数是Promise对象的状态变为Reject时调用。其中，第二个函数是可选的，不一定要提供。<br>这两个函数都接受Promise对象传出的值作为参数。<br>下面是一个Promise对象的简单例子。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">function timeout(ms) &#123;</div><div class="line">  return new Promise((resolve) =&gt; &#123;</div><div class="line">    setTimeout(resolve, ms, &apos;done&apos;);</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line">timeout(100).then((value) =&gt; &#123;</div><div class="line">  console.log(value);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>上面代码中，timeout方法返回一个Promise实例，表示一段时间以后才会发生的结果。过了指定的时间<br>（ms参数）以后，Promise实例的状态变为Resolved，就会触发then方法绑定的回调函数。</p>
<p>如果调用resolve函数和reject函数时带有参数，那么它们的参数会被传递给回调函数。reject函数的参数<br>通常是Error对象的实例，表示抛出的错误；resolve函数的参数除了正常的值以外，还可能是另一个<br>Promise实例，表示异步操作的结果有可能是一个值，也有可能是另一个异步操作，比如像下面这样。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var p1 = new Promise(function(resolve, reject)&#123;</div><div class="line">  // ...</div><div class="line">&#125;);</div><div class="line">var p2 = new Promise(function(resolve, reject)&#123;</div><div class="line">  // ...</div><div class="line">  resolve(p1);</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>上面代码中，p1和p2都是Promise的实例，但是p2的resolve方法将p1作为参数，即一个异步操作的结果<br>是返回另一个异步操作。<br>注意，这时p1的状态就会传递给p2，也就是说，p1的状态决定了p2的状态。如果p1的状态是Pending，<br>那么p2的回调函数就会等待p1的状态改变；如果p1的状态已经是Resolved或者Rejected，那么p2的回调<br>函数将会立刻执行。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ES6/">ES6</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-fresco-example" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/01/fresco-example/" class="article-date">
  	<time datetime="2016-06-01T01:49:48.000Z" itemprop="datePublished">2016-06-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/01/fresco-example/">Fresco使用实例</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Fresco实例有效果图："><a href="#Fresco实例有效果图：" class="headerlink" title="Fresco实例有效果图："></a>Fresco实例有效果图：</h3><p><img src="/image/fresco_test.png" alt="Fresco Example"></p>
<h3 id="Fresco项目的结构："><a href="#Fresco项目的结构：" class="headerlink" title="Fresco项目的结构："></a>Fresco项目的结构：</h3><p><img src="/image/fresco_struct.jpg" alt="Fresco struct"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:paddingBottom=&quot;@dimen/activity_vertical_margin&quot;</div><div class="line">    android:paddingLeft=&quot;@dimen/activity_horizontal_margin&quot;</div><div class="line">    android:paddingRight=&quot;@dimen/activity_horizontal_margin&quot;</div><div class="line">    android:paddingTop=&quot;@dimen/activity_vertical_margin&quot;</div><div class="line">    tools:context=&quot;com.shen.frescotest.MainActivity&quot; &gt;</div><div class="line"></div><div class="line">    </div><div class="line">  	&lt;ListView </div><div class="line">  	    android:id=&quot;@+id/listview&quot;</div><div class="line">  	    android:layout_width=&quot;fill_parent&quot;</div><div class="line">  	    android:layout_height=&quot;fill_parent&quot;</div><div class="line">  	    android:dividerHeight=&quot;1dip&quot;</div><div class="line">  	    /&gt;</div><div class="line">    </div><div class="line">&lt;/RelativeLayout&gt;</div></pre></td></tr></table></figure>
<h3 id="listview中条目的布局代码："><a href="#listview中条目的布局代码：" class="headerlink" title="listview中条目的布局代码："></a>listview中条目的布局代码：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    android:layout_width=&quot;wrap_content&quot;</div><div class="line">    android:layout_height=&quot;wrap_content&quot;</div><div class="line">    android:orientation=&quot;horizontal&quot;</div><div class="line">    android:layout_gravity=&quot;center_vertical&quot;</div><div class="line">    android:padding=&quot;5dip&quot; &gt;</div><div class="line"></div><div class="line">    &lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">	    android:id=&quot;@+id/my_image_view&quot;</div><div class="line">	    android:layout_width=&quot;120dp&quot;</div><div class="line">	    android:layout_height=&quot;wrap_content&quot;</div><div class="line">	    fresco:viewAspectRatio=&quot;1&quot;</div><div class="line">	    fresco:fadeDuration=&quot;300&quot;</div><div class="line">	    fresco:actualImageScaleType=&quot;fitCenter&quot;</div><div class="line">	    fresco:placeholderImage=&quot;@drawable/ic_launcher&quot;</div><div class="line">	    fresco:failureImage=&quot;@drawable/ic_launcher&quot;</div><div class="line">	    fresco:roundAsCircle=&quot;true&quot;</div><div class="line">	    fresco:roundedCornerRadius=&quot;10dp&quot;</div><div class="line">	    fresco:roundTopLeft=&quot;true&quot;</div><div class="line">	    fresco:roundTopRight=&quot;true&quot;</div><div class="line">	    fresco:roundBottomLeft=&quot;true&quot;</div><div class="line">	    fresco:roundBottomRight=&quot;true&quot;</div><div class="line">	    fresco:roundingBorderWidth=&quot;1dp&quot;</div><div class="line">	    fresco:roundingBorderColor=&quot;#00ffff&quot;</div><div class="line">    	/&gt;</div><div class="line">    </div><div class="line">    </div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/imageView1&quot;</div><div class="line">        android:layout_width=&quot;60dip&quot;</div><div class="line">        android:layout_height=&quot;60dip&quot;</div><div class="line">        android:src=&quot;@drawable/ic_launcher&quot;</div><div class="line">        android:visibility=&quot;gone&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;LinearLayout</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;</div><div class="line">        android:orientation=&quot;vertical&quot;</div><div class="line">        android:layout_marginLeft=&quot;15dip&quot;</div><div class="line">         &gt;</div><div class="line"></div><div class="line">        &lt;TextView</div><div class="line">            android:id=&quot;@+id/textView1&quot;</div><div class="line">            android:layout_width=&quot;wrap_content&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:text=&quot;TextView&quot; </div><div class="line">            android:textSize=&quot;20sp&quot;</div><div class="line">            android:layout_marginTop=&quot;5dip&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;TextView</div><div class="line">            android:id=&quot;@+id/textView2&quot;</div><div class="line">            android:layout_width=&quot;wrap_content&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:text=&quot;TextView&quot; </div><div class="line">            android:textSize=&quot;14sp&quot;</div><div class="line">            android:layout_marginTop=&quot;2dip&quot;/&gt;</div><div class="line">    &lt;/LinearLayout&gt;</div><div class="line"></div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<h3 id="SimpleDraweeView的xml属性："><a href="#SimpleDraweeView的xml属性：" class="headerlink" title="SimpleDraweeView的xml属性："></a>SimpleDraweeView的xml属性：</h3><p>1.强制性的宽高</p>
<p>你必须声明 android:layout_width 和 android:layout_height。如果没有在XML中声明这两个属性，将无法正确加载图像。</p>
<p>wrap_content<br>Drawees 不支持 wrap_content 属性。</p>
<p>所下载的图像可能和占位图尺寸不一致，如果设置出错图或者重试图的话，这些图的尺寸也可能和所下载的图尺寸不一致。</p>
<p>如果大小不一致，假设使用的是 wrap_content，图像下载完之后，View将会重新layout，改变大小和位置。这将会导致界面跳跃。</p>
<p>固定宽高比<br>只有希望显示固定的宽高比时，可以使用wrap_content。</p>
<p>2.如果希望图片以特定的宽高比例显示，例如 4:3，可以在XML中指定fresco:viewAspectRatio属性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">    android:id=&quot;@+id/my_image_view&quot;</div><div class="line">    android:layout_width=&quot;20dp&quot;</div><div class="line">    android:layout_height=&quot;wrap_content&quot;</div><div class="line">    fresco:viewAspectRatio=&quot;1.33&quot;</div><div class="line">    &lt;!-- other attributes --&gt;</div></pre></td></tr></table></figure></p>
<p>也可以在代码中指定显示比例：</p>
<p>mSimpleDraweeView.setAspectRatio(1.33f);<br>项目中设置的1：1也就是说宽高都是120dp</p>
<p>3.fresco:actualImageScaleType表求缩放类型，其值如下所示：<br>center    居中，无缩放。<br>centerCrop    保持宽高比缩小或放大，使得两边都大于或等于显示边界，且宽或高契合显示边界。居中显示。<br>focusCrop    同centerCrop, 但居中点不是中点，而是指定的某个点。<br>centerInside    缩放图片使两边都在显示边界内，居中显示。和 fitCenter 不同，不会对图片进行放大。<br>如果图尺寸大于显示边界，则保持长宽比缩小图片。<br>fitCenter    保持宽高比，缩小或者放大，使得图片完全显示在显示边界内，且宽或高契合显示边界。居中显示。<br>fitStart    同上。但不居中，和显示边界左上对齐。<br>fitEnd    同fitCenter， 但不居中，和显示边界右下对齐。<br>fitXY    不保存宽高比，填充满显示边界。<br>none    如要使用tile mode显示, 需要设置为none</p>
<p>4.圆角<br>圆角实际有2种呈现方式:</p>
<p>圆圈 - 设置roundAsCircle为true<br>圆角 - 设置roundedCornerRadius<br>设置圆角时，支持4个角不同的半径。XML中无法配置，但可在Java代码中配置。</p>
<p>设置圆角<br>可使用以下两种方式:</p>
<p>默认使用一个 shader 绘制圆角，但是仅仅占位图和所要显示的图有圆角效果。失败示意图和重下载示意图无圆角效果，且这种圆角方式不支持动画。<br>叠加一个solid color来绘制圆角。但是背景需要固定成指定的颜色。 在XML中指定 roundWithOverlayColor, 或者通过调用setOverlayColor来完成此设定。</p>
<p>5.其他<br>fresco:placeholderImage=”@drawable/ic_launcher” 表示点位图片<br>fresco:failureImage=”@drawable/ic_launcher”表示失败后显示的图片<br>fresco:roundingBorderWidth=”1dp” 表示图片圆的边线宽度<br>fresco:roundingBorderColor=”#00ffff”表示圆线的颜色</p>
<h3 id="主MainActivity的代码如下："><a href="#主MainActivity的代码如下：" class="headerlink" title="主MainActivity的代码如下："></a>主MainActivity的代码如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line">package com.shen.frescotest;</div><div class="line"></div><div class="line">import java.util.ArrayList;</div><div class="line"></div><div class="line">import android.app.Activity;</div><div class="line">import android.net.Uri;</div><div class="line">import android.os.Bundle;</div><div class="line">import android.view.LayoutInflater;</div><div class="line">import android.view.Menu;</div><div class="line">import android.view.MenuItem;</div><div class="line">import android.view.View;</div><div class="line">import android.view.ViewGroup;</div><div class="line">import android.widget.BaseAdapter;</div><div class="line">import android.widget.ListView;</div><div class="line">import android.widget.TextView;</div><div class="line"></div><div class="line">import com.facebook.drawee.backends.pipeline.Fresco;</div><div class="line">import com.facebook.drawee.interfaces.DraweeController;</div><div class="line">import com.facebook.drawee.view.SimpleDraweeView;</div><div class="line"></div><div class="line">public class MainActivity extends Activity &#123;</div><div class="line">	//设置图片请求的基础地址</div><div class="line">	private static final String BASE_URL = &quot;http://img1.3lian.com/img2011/w1/106/85/&quot;;</div><div class="line">	</div><div class="line">	@Override</div><div class="line">	protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">		super.onCreate(savedInstanceState);</div><div class="line">		Fresco.initialize(this);</div><div class="line">		setContentView(R.layout.activity_main);</div><div class="line">		//创建一组数据用来填充ListView时在界面显示数据</div><div class="line">		ArrayList&lt;Product&gt; dishList = new ArrayList&lt;Product&gt;();</div><div class="line"></div><div class="line">		dishList.add(new Product(BASE_URL + &quot;42.jpg&quot;, &quot;水煮鱼片&quot;, &quot;38.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;34.jpg&quot;, &quot;小炒肉&quot;, &quot;18.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;37.jpg&quot;, &quot;清炒时蔬&quot;, &quot;15.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;11.jpg&quot;, &quot;金牌烤鸭&quot;, &quot;36.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;12.jpg&quot;, &quot;粉丝肉煲&quot;, &quot;20.00&quot;));</div><div class="line">		</div><div class="line">		</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;42.jpg&quot;, &quot;水煮鱼片&quot;, &quot;38.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;34.jpg&quot;, &quot;小炒肉&quot;, &quot;18.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;37.jpg&quot;, &quot;清炒时蔬&quot;, &quot;15.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;11.jpg&quot;, &quot;金牌烤鸭&quot;, &quot;36.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;12.jpg&quot;, &quot;粉丝肉煲&quot;, &quot;20.00&quot;));</div><div class="line">		</div><div class="line">		//获取ListView组件并设置数据适配器</div><div class="line">		ListView mListView = (ListView) this.findViewById(R.id.listview);</div><div class="line">		ProductListViewAdapter adapter = new ProductListViewAdapter(dishList);</div><div class="line">		mListView.setAdapter(adapter);</div><div class="line">		</div><div class="line">		</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public boolean onCreateOptionsMenu(Menu menu) &#123;</div><div class="line">		// Inflate the menu; this adds items to the action bar if it is present.</div><div class="line">		getMenuInflater().inflate(R.menu.main, menu);</div><div class="line">		return true;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public boolean onOptionsItemSelected(MenuItem item) &#123;</div><div class="line">		// Handle action bar item clicks here. The action bar will</div><div class="line">		// automatically handle clicks on the Home/Up button, so long</div><div class="line">		// as you specify a parent activity in AndroidManifest.xml.</div><div class="line">		int id = item.getItemId();</div><div class="line">		if (id == R.id.action_settings) &#123;</div><div class="line">			return true;</div><div class="line">		&#125;</div><div class="line">		return super.onOptionsItemSelected(item);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	</div><div class="line">	// ListView适配器</div><div class="line">	private class ProductListViewAdapter extends BaseAdapter &#123;</div><div class="line"></div><div class="line">		private ArrayList&lt;Product&gt; dataList;</div><div class="line"></div><div class="line">		public ProductListViewAdapter(ArrayList&lt;Product&gt; list) &#123;</div><div class="line">			this.dataList = list;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		@Override</div><div class="line">		public int getCount() &#123;</div><div class="line">			return dataList.size();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		@Override</div><div class="line">		public Object getItem(int position) &#123;</div><div class="line">			return dataList.get(position);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		@Override</div><div class="line">		public long getItemId(int position) &#123;</div><div class="line">			return position;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">			@Override</div><div class="line">			public View getView(int position, View convertView, ViewGroup parent) &#123;</div><div class="line">				ListViewItemHolder item = null;</div><div class="line">				if (convertView == null) &#123;</div><div class="line">					convertView = LayoutInflater.from(MainActivity.this).inflate(</div><div class="line">							R.layout.main_listview_item, null);</div><div class="line">					item = new ListViewItemHolder();</div><div class="line">					item.img_iv = (SimpleDraweeView) convertView</div><div class="line">							.findViewById(R.id.my_image_view);</div><div class="line">					item.name_textview = (TextView) convertView</div><div class="line">							.findViewById(R.id.textView1);</div><div class="line">					item.price_textview = (TextView) convertView</div><div class="line">							.findViewById(R.id.textView2);</div><div class="line"></div><div class="line">					convertView.setTag(item);</div><div class="line">				&#125; else &#123;</div><div class="line">					item = (ListViewItemHolder) convertView.getTag();</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				Product product = dataList.get(position);</div><div class="line"></div><div class="line">				Uri uri = Uri.parse(product.getImgUrl());</div><div class="line">//				SimpleDraweeView draweeView = (SimpleDraweeView) findViewById(R.id.my_image_view);</div><div class="line">//				draweeView.setImageURI(uri);</div><div class="line">				item.img_iv.setImageURI(uri);</div><div class="line">				</div><div class="line">				DraweeController draweeController = Fresco.newDraweeControllerBuilder().setUri(product.getImgUrl()).build();</div><div class="line">				</div><div class="line">//				item.img_iv.setController(new DraweeController()&#123;</div><div class="line">//					</div><div class="line">//					</div><div class="line">//					</div><div class="line">//				&#125;);</div><div class="line">				</div><div class="line">				item.name_textview.setText(product.getName());</div><div class="line">				item.price_textview.setText(product.getPrice() + &quot;元&quot;);</div><div class="line"></div><div class="line">				return convertView;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// ListView的Item组件类</div><div class="line">		private class ListViewItemHolder &#123;</div><div class="line">			SimpleDraweeView img_iv;</div><div class="line">			TextView name_textview;</div><div class="line">			TextView price_textview;</div><div class="line">		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://github.com/shenjianli/FrescoTest" target="_blank" rel="external">源代码</a></p>
<p>扩展阅读：</p>
<p><a href="http://frescolib.org/" target="_blank" rel="external">http://frescolib.org/</a></p>
<p><a href="http://frescolib.org/" target="_blank" rel="external">http://www.fresco-cn.org/</a></p>
<p><a href="https://github.com/facebook/fresco" target="_blank" rel="external">https://github.com/facebook/fresco</a></p>
<p><a href="http://www.codeceo.com/article/android-fresco-usage.html" target="_blank" rel="external">http://www.codeceo.com/article/android-fresco-usage.html</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fresco/">Fresco</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-fresco-example-introduce" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/31/fresco-example-introduce/" class="article-date">
  	<time datetime="2016-05-31T01:05:13.000Z" itemprop="datePublished">2016-05-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/31/fresco-example-introduce/">Fresco 使用实例</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Fresco解决的问题"><a href="#Fresco解决的问题" class="headerlink" title="Fresco解决的问题"></a>Fresco解决的问题</h2><p>在Android设备上面，快速高效的显示图片是极为重要的。过去的几年里，我们在如何高效的存储图像这方面遇到了很多问题。图片太大，但是手机的 内存却很小。每一个像素的R、G、B和alpha通道总共要占用4byte的空间。如果手机的屏幕是480*800,那么一张屏幕大小的图片就要占用 1.5M的内存。手机的内存通常很小，特别是Android设备还要给各个应用分配内存。在某些设备上，分给Facebook App的内存仅仅有16MB。一张图片就要占据其内存的十分之一。</p>
<p>当你的App内存溢出会发生什么呢？它当然会崩溃！Fresco就是用来解决这个问题。它可以管理使用到的图片和内存，从此App不再崩溃。</p>
<h2 id="Fresco内存区"><a href="#Fresco内存区" class="headerlink" title="Fresco内存区"></a>Fresco内存区</h2><h3 id="1-Android中每个App的-Java堆内存大小都是被严格的限制的。每个对象都是使用Java的new在堆内存实例化"><a href="#1-Android中每个App的-Java堆内存大小都是被严格的限制的。每个对象都是使用Java的new在堆内存实例化" class="headerlink" title="1.Android中每个App的 Java堆内存大小都是被严格的限制的。每个对象都是使用Java的new在堆内存实例化"></a>1.Android中每个App的 Java堆内存大小都是被严格的限制的。每个对象都是使用Java的new在堆内存实例化</h3><p>Fresco是由Facebook开发的，为了理解Facebook到底做了什么工作，在此之前我们需要了解在Android可以使用的堆内存之间的区别。<br>Android中每个App的 Java堆内存大小都是被严格的限制的。每个对象都是使用Java的new在堆内存实例化，这是内存中相对安全的一块区域。内存有垃圾回收机制，所以当 App不在使用内存的时候，系统就会自动把这块内存回收。</p>
<p>不幸的是，内存进行垃圾回收的过程正是问题所在。当内存进行垃圾回收时，内存不仅仅进行了垃圾回收，还把 Android 应用完全终止了。这也是用户在使用 App 时最常见的卡顿或短暂假死的原因之一。这会让正在使用 App 的用户非常郁闷，然后他们可能会焦躁地滑动屏幕或者点击按钮，但 App 唯一的响应就是：在 App 恢复正常之前，请求用户耐心等待</p>
<h3 id="2-Native堆是由C-程序的new进行分配的"><a href="#2-Native堆是由C-程序的new进行分配的" class="headerlink" title="2.Native堆是由C++程序的new进行分配的"></a>2.Native堆是由C++程序的new进行分配的</h3><p>相比之下，Native堆是由C++程序的new进行分配的。在Native堆里面有更多可用内存，App只被设备的物理可用内存限制，而且没有垃圾回收机制或其他东西拖后腿。但是c++程序员必须自己回收所分配的每一块内存，否则就会造成内存泄露，最终导致程序崩溃。</p>
<h3 id="3-Android有另外一种内存区域，叫做Ashmem"><a href="#3-Android有另外一种内存区域，叫做Ashmem" class="headerlink" title="3.Android有另外一种内存区域，叫做Ashmem"></a>3.Android有另外一种内存区域，叫做Ashmem</h3><p>Android有另外一种内存区域，叫做Ashmem，它操作起来更像Native堆，但是也有额外的系统调用。Android 在操作 Ashmem 堆时，会把该堆中存有数据的内存区域从 Ashmem 堆中抽取出来，而不是把它释放掉，这是一种弱内存释放模式；被抽取出来的这部分内存只有当系统真正需要更多的内存时（系统内存不够用）才会被释放。当 Android 把被抽取出来的这部分内存放回 Ashmem 堆，只要被抽取的内存空间没有被释放，之前的数据就会恢复到相应的位置。</p>
<h3 id="4-可消除的Bitmap"><a href="#4-可消除的Bitmap" class="headerlink" title="4.可消除的Bitmap"></a>4.可消除的Bitmap</h3><p>Ashmem不能被Java应用直接处理，但是也有一些例外，图片就是其中之一。当你创建一张没有经过压缩的Bitmap的时候，Android的API允许你指定是否是可清除的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">BitmapFactory.Options = new BitmapFactory.Options();</div><div class="line">options.inPurgeable = true;</div><div class="line">Bitmap bitmap = BitmapFactory.decodeByteArray(jpeg, 0, jpeg.length, options);</div></pre></td></tr></table></figure>
<p>经过上面的代码处理后，### 可清除的Bitmap会驻留在 Ashmem 堆中。<br>不管发生什么，垃圾回收器都不会自动回收这些 Bitmap。当 Android 绘制系统在渲染这些图片，Android 的系统库就会把这些 Bitmap 从 Ashmem 堆中抽取出来，而当渲染结束后，这些 Bitmap 又会被放回到原来的位置。如果一个被抽取的图片需要再绘制一次，系统仅仅需要把它再解码一次，这个操作非常迅速。</p>
<p>这听起来像一个完美的解决方案，但是问题是Bitmap解码的操作是运行在UI线程的。Bitmap解码是非常消耗CPU资源的，当消耗过大时会引起UI阻塞。因为这个原因，所以Google不推荐使用这个特性。 现在它们推荐使用另外一个特性——inBitmap。但是这个特性直到Android3.0之后才被支持。即使是这样，这个特性也不是非常有用，除非 App 里的所有图片大小都相同，这对Fackbook来说显然是不适用的。一直到4.4版本，这个限制才被移除了。但我们需要的是能够运行在 Android 2.3-最新版本中的通用解决方案。</p>
<h2 id="自力更生"><a href="#自力更生" class="headerlink" title="自力更生"></a>自力更生</h2><p>提到的“解码操作致使 UI 假死”的问题，我们找到了一种同时使 UI 显示和内存管理都表现良好的解决方法。如果我们在 UI 线程进行渲染之前把被抽取的内存区域放回到原来的位置，并确保它再也不会被抽取，那我们就可以把这些图片放在 Ashmem 里，同时不会出现 UI 假死的问题。幸运的是，Android 的 NDK 中有一个函数可以完美地实现这个需求，名字叫做 AndroidBitmap_lockPixels。这个函数最初的目的就是：在调用 unlockPixels 再次抽取内存区域后被执行。<br>当我们意识到我们没有必要这样做的时候，我们取得了突破。如果我们只调用lockPixels而不调用对应的unlockPixels，那么我们就 可以在Java的堆内存里面创建一个内存安全的图像，并且不会导致UI线程加载缓慢。只需要几行c++代码，我们就完美的解决了这个问题。</p>
<p>用C++的思想写Java代码就像《蜘蛛侠》里面说的：“能力越强，责任越大。”可清除的 Bitmap 既不会被垃圾回收器回收，也不会被 Ashmem 内置的清除机制处理，这使得使用它们可能会造成内存泄露。所以我们只能靠自己啦。<br>在c++中,通常的解决方案是建立智能指针类,实现引用计数。这些需要利用到c++的语言特性——拷贝构造函数、赋值操作符和确定的析构函数。这种语法在Java之中不存在，因为垃圾回收器能够处理这一切。所以我们必须以某种方式在Java中实现C++的这些保证机制。<br>我们创建了两个类去完成这件事。其中一个叫做“SharedReference”，它有addReference和deleteReference 两个方法，调用者调用时必须采取基类对象或让它在范围之外。一旦引用计数器归零，资源处理(Bitmap.recycle)就会发生。<br>然而，很显然，让Java开发者去调用这些方法是很容易出错的。Java语言就是为了避免做这样的事情的！所以SharedReference之 上,我们构建了CloseableReference类。它不仅实现了Java的Closeable接口,而且也实现了Cloneable接口。它的构造 器和clone()方法会调用addReference()，而close()方法会调用deleteReference()。所以Java开发者需要遵 守下面两条简单的的规则：</p>
<ol>
<li><p>在分配CloseableReference新对象的时候,调用.clone()。</p>
</li>
<li><p>在超出作用域范围的时候，调用.close()，这通常是在finally代码块中。</p>
</li>
</ol>
<p>这些规则可以有效地防止内存泄漏,并让我们在像Fackbook的Android客户端这种大型的Java程序中享受Native内存管理和通信。</p>
<h2 id="不仅仅是加载程序，它是一个管道"><a href="#不仅仅是加载程序，它是一个管道" class="headerlink" title="不仅仅是加载程序，它是一个管道"></a>不仅仅是加载程序，它是一个管道</h2><p>在移动设备上显示图片需要很多的步骤：<br><img src="/image/fresco_cache.png" alt="image cache"></p>
<p>几个优秀的开源库都是按照这个顺序执行的，比如 Picasso,Universal Image Loader,Glide和 Volley等等。上面这些开源库为Android的发展做出了非常重要的贡献。我们相信Fresco在几个重要方面会表现的更好。<br>我们的不同之处在于把上面的这些步骤看作是管道，而不仅仅是加载器。每一个步骤和其他方面应该是尽可能独立的，把数据和参数传递进去，然后产生一个 输出，就这么简单。它应该可以做一些操作，不管是并行还是串行。一些操作只能在特性条件下才能执行。一些有特殊要求的在线程上执行。除此之外，当我们考虑 改进图像的时候，所有的图片就会变得非常复杂。很多人在低网速情况下使用Facebook，我们想要这些人能够尽快的看到图片，甚至经常是在图片没有完全 下载完之前。</p>
<h2 id="不要烦恼，拥抱stream"><a href="#不要烦恼，拥抱stream" class="headerlink" title="不要烦恼，拥抱stream"></a>不要烦恼，拥抱stream</h2><p>在Java中，异步代码历来都是通过Future机制来执行的。在另外的线程里面代码被提交执行，然后一个类似Future的对象可以检查执行的结 果是不是已经完成了。但是，这只在假设只有一种结果的情况下行得通。在处理渐进的图像的时候，我们希望可以完整而且连续的显示结果。<br>我们的解决方式是定义一个更广义的Future版本，叫做DataSource。它提供了一个订阅方法，调用者必须传入一个 DataSubscriber和Executor。DataSubscriber可以从DataSource获取到处理中和处理完毕的结果，并且提供了很 简单的方法来区分。因为我们需要非常频繁的处理这些对象，所以必须有一个明确的close调用，幸运的是，DataSource本身就是 Closeable。<br>在后台，每一个箱子上面都实现了一个叫做“生产者/消费者”的新框架。在这个问题是，我们是从ReactiveX获取的灵感。我们的系统拥有和RxJava相似的接口，但是更加适合移动设备，并且有内置的对Closeables的支持。<br>保持简单的接口。</p>
<h2 id="动画全覆盖"><a href="#动画全覆盖" class="headerlink" title="动画全覆盖"></a>动画全覆盖</h2><p>使用Facebook的人都非常喜欢Stickers，因为它可以以动画形式存储GIF和Web格式。如果支持这些格式，就需要面临新的挑战。因为 每一个动画都是由不止一张图片组成的，你需要解码每一张图片，存储在内存里，然后显示出来。对于大一点的动画，把每一帧图片放在内存是不可行的。<br>我们建立了AnimatedDrawable,一个强大的可以呈现动画的Drawable,同时支持GIF和WebP格式。 AnimatedDrawable实现标准的Android Animatable接口,所以调用者可以随意的启动或者停止动画。为了优化内存使用，如果图片足够小的时候，我们就在内存里面缓存这些图片，但是如果太 大，我们可以迅速的解码这些图片。这些行为调用者是完全可控的。<br>所有的后台都用c++代码实现。我们保持一份解码数据和元数据解析,如宽度和高度。我们引用技术数据，它允许多个Java端的Drawables同时访问一个WebP图像。</p>
<h2 id="如何去爱你？"><a href="#如何去爱你？" class="headerlink" title="如何去爱你？"></a>如何去爱你？</h2><p>我来告诉你…当一张图片从网络上下载下来之后，我们想显示一张占位图。如果下载失败了，我们就会显示一个错误标志。当图片加载完之后，我们有一个渐变动画。通过 使用硬件加速，我们可以按比例放缩，或者是矩阵变换成我们想要的大小然后渲染。我们不总是按照图片的中心进行放缩，那么我们可以自己定义放缩的聚焦点。有 些时候，我们想显示圆角甚至是圆形的图片。所有的这些操作都应该是迅速而平滑的。<br>我们之前的实现是使用Android的View对象——时机到了，可以使用ImageView替换出占位的View。这个操作是非常慢的。改变 View会让Android强制刷新整个布局，当用户滑动的时候，这绝对不是你想看到的效果。比较明智的做法是使用Android的Drawables, 它可以迅速的被替换。<br>所以我们创建了Drawee。这是一个像MVC架构的图片显示框架。该模型被称为DraweeHierarchy。它被实现为Drawables的一个层，对于底层的图像而言，每一个曾都有特定的功能——成像、层叠、渐变或者是放缩。<br>DraweeControllers通过管道的方式连接到图像上——或者是其他的图片加载库——并且处理后台的图片操作。他们从管道接收事件并决定如何处理他们。他们控制DraweeHierarchy实际上的操作——无论是占位图片,错误条件或是完成的图片。<br>DraweeViews 的功能不多,但都是至关重要的。他们监听Android的View不再显示在屏幕上的系统事件。当图片离开屏幕的时候,DraweeView可以告诉 DraweeController关闭使用的图像资源。这可以避免内存泄露。此外,如果它已经不在屏幕范围内的话，控制器会告诉图片管道取消网络请求。因 此，像Fackbook那样滚动一长串的图片的时候，不会频繁的网络请求。<br>通过这些努力，显示图片的辛苦操作一去不复返了。调用代码只需要实例化一个DraweeView,然后指定一个URI和其他可选的参数就可以了。剩下的一切都会自动完成。开发人员不需要担心管理图像内存，或更新图像流。Fresco为他们把一切都做了。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fresco/">Fresco</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Picasso-Text-Example" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/27/Picasso-Text-Example/" class="article-date">
  	<time datetime="2016-05-27T06:50:52.000Z" itemprop="datePublished">2016-05-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/27/Picasso-Text-Example/">Picasso使用实例</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Picasso使用实例"><a href="#Picasso使用实例" class="headerlink" title="Picasso使用实例"></a>Picasso使用实例</h2><h3 id="实现的例子效果图如下："><a href="#实现的例子效果图如下：" class="headerlink" title="实现的例子效果图如下："></a>实现的例子效果图如下：</h3><p><img src="/image/Picasso_test.png" alt="picasso"><br>图片右上角红色三角表示这张图片是从网络上下载显示出来的，绿色三角表示是从内存缓存中加载的图片</p>
<p><img src="/image/Picasso_test1.png" alt="picasso test"><br>这张效果图中的黄色三角表示图片是从本地缓存中读取出来的</p>
<h3 id="这个例子的工程结构图如下："><a href="#这个例子的工程结构图如下：" class="headerlink" title="这个例子的工程结构图如下："></a>这个例子的工程结构图如下：</h3><p><img src="/image/Picasso_struct_pic.jpg" alt="picasso struct"></p>
<p>主布局文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    tools:context=&quot;$&#123;relativePackage&#125;.$&#123;activityClass&#125;&quot; &gt;</div><div class="line">    &lt;ListView</div><div class="line">        android:id=&quot;@+id/listview&quot;</div><div class="line">        android:layout_width=&quot;fill_parent&quot;</div><div class="line">        android:layout_height=&quot;fill_parent&quot;</div><div class="line">        android:dividerHeight=&quot;1dip&quot; /&gt;</div><div class="line">&lt;/RelativeLayout&gt;</div></pre></td></tr></table></figure></p>
<p>这个布局文件就是全屏显示一个列表ListView视图控件，没有什么要说的！</p>
<p>ListView中Item布局如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:layout_width=&quot;wrap_content&quot;</div><div class="line">    android:layout_height=&quot;wrap_content&quot;</div><div class="line">    android:orientation=&quot;horizontal&quot;</div><div class="line">    android:layout_gravity=&quot;center_vertical&quot;</div><div class="line">    android:padding=&quot;5dip&quot; &gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/imageView1&quot;</div><div class="line">        android:layout_width=&quot;60dip&quot;</div><div class="line">        android:layout_height=&quot;60dip&quot;</div><div class="line">        android:src=&quot;@drawable/ic_launcher&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;LinearLayout</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;</div><div class="line">        android:orientation=&quot;vertical&quot;</div><div class="line">        android:layout_marginLeft=&quot;15dip&quot;</div><div class="line">         &gt;</div><div class="line"></div><div class="line">        &lt;TextView</div><div class="line">            android:id=&quot;@+id/textView1&quot;</div><div class="line">            android:layout_width=&quot;wrap_content&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:text=&quot;TextView&quot; </div><div class="line">            android:textSize=&quot;20sp&quot;</div><div class="line">            android:layout_marginTop=&quot;5dip&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;TextView</div><div class="line">            android:id=&quot;@+id/textView2&quot;</div><div class="line">            android:layout_width=&quot;wrap_content&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:text=&quot;TextView&quot; </div><div class="line">            android:textSize=&quot;14sp&quot;</div><div class="line">            android:layout_marginTop=&quot;2dip&quot;/&gt;</div><div class="line">    &lt;/LinearLayout&gt;</div><div class="line"></div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure></p>
<p>这个布局文件是用来设置ListView中每项需要显示的控件，左边ImageView显示一张图片，右边坚排两个TextView来显示两段文字！</p>
<p>MainActivity和Listview适配器代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">package com.shen.picasso;</div><div class="line"></div><div class="line">import java.util.ArrayList;</div><div class="line"></div><div class="line">import android.app.Activity;</div><div class="line">import android.os.Bundle;</div><div class="line">import android.view.LayoutInflater;</div><div class="line">import android.view.View;</div><div class="line">import android.view.ViewGroup;</div><div class="line">import android.widget.BaseAdapter;</div><div class="line">import android.widget.ImageView;</div><div class="line">import android.widget.ListView;</div><div class="line">import android.widget.TextView;</div><div class="line"></div><div class="line">import com.squareup.picasso.Picasso;</div><div class="line"></div><div class="line">public class MainActivity extends Activity &#123;</div><div class="line">	//设置图片请求的基础地址</div><div class="line">	private static final String BASE_URL = &quot;http://img1.3lian.com/img2011/w1/106/85/&quot;;</div><div class="line">	</div><div class="line">	@Override</div><div class="line">	protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">		super.onCreate(savedInstanceState);</div><div class="line">		setContentView(R.layout.activity_main);</div><div class="line">		//创建一组数据用来填充ListView时在界面显示数据</div><div class="line">		ArrayList&lt;Product&gt; dishList = new ArrayList&lt;Product&gt;();</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;42.jpg&quot;, &quot;水煮鱼片&quot;, &quot;38.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;34.jpg&quot;, &quot;小炒肉&quot;, &quot;18.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;37.jpg&quot;, &quot;清炒时蔬&quot;, &quot;15.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;11.jpg&quot;, &quot;金牌烤鸭&quot;, &quot;36.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;12.jpg&quot;, &quot;粉丝肉煲&quot;, &quot;20.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;42.jpg&quot;, &quot;水煮鱼片&quot;, &quot;38.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;34.jpg&quot;, &quot;小炒肉&quot;, &quot;18.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;37.jpg&quot;, &quot;清炒时蔬&quot;, &quot;15.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;11.jpg&quot;, &quot;金牌烤鸭&quot;, &quot;36.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;12.jpg&quot;, &quot;粉丝肉煲&quot;, &quot;20.00&quot;));</div><div class="line">		dishList.add(new Product(BASE_URL + &quot;42.jpg&quot;, &quot;水煮鱼片&quot;, &quot;38.00&quot;));</div><div class="line">		</div><div class="line">		//获取ListView组件并设置数据适配器</div><div class="line">		ListView mListView = (ListView) this.findViewById(R.id.listview);</div><div class="line">		ProductListViewAdapter adapter = new ProductListViewAdapter(dishList);</div><div class="line">		mListView.setAdapter(adapter);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// ListView适配器</div><div class="line">	private class ProductListViewAdapter extends BaseAdapter &#123;</div><div class="line"></div><div class="line">		private ArrayList&lt;Product&gt; dataList;</div><div class="line"></div><div class="line">		public ProductListViewAdapter(ArrayList&lt;Product&gt; list) &#123;</div><div class="line">			this.dataList = list;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		@Override</div><div class="line">		public int getCount() &#123;</div><div class="line">			return dataList.size();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		@Override</div><div class="line">		public Object getItem(int position) &#123;</div><div class="line">			return dataList.get(position);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		@Override</div><div class="line">		public long getItemId(int position) &#123;</div><div class="line">			return position;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		@Override</div><div class="line">		public View getView(int position, View convertView, ViewGroup parent) &#123;</div><div class="line">			ListViewItemHolder item = null;</div><div class="line">			//加载ListView中每项的布局文件</div><div class="line">			if (convertView == null) &#123;</div><div class="line">				convertView = LayoutInflater.from(MainActivity.this).inflate(</div><div class="line">						R.layout.product_listview_item, null);</div><div class="line">				item = new ListViewItemHolder();</div><div class="line">				item.imgIv = (ImageView) convertView</div><div class="line">						.findViewById(R.id.imageView1);</div><div class="line">				item.nameTv = (TextView) convertView</div><div class="line">						.findViewById(R.id.textView1);</div><div class="line">				item.priceTv = (TextView) convertView</div><div class="line">						.findViewById(R.id.textView2);</div><div class="line"></div><div class="line">				convertView.setTag(item);</div><div class="line">			&#125; else &#123;</div><div class="line">				item = (ListViewItemHolder) convertView.getTag();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			Product product = dataList.get(position);</div><div class="line"></div><div class="line">			//设置是否在图片右上角显示三角形来说明图片来源（网络，本地，内存）</div><div class="line">			Picasso.with(MainActivity.this).setIndicatorsEnabled(true);</div><div class="line">			</div><div class="line">			//这里就是异步加载网络图片的地方</div><div class="line">			Picasso.with(MainActivity.this).load(product.getImgUrl()).transform(new CircleTransform())</div><div class="line">					.into(item.imgIv);</div><div class="line"></div><div class="line">			item.nameTv.setText(product.getName());</div><div class="line">			item.priceTv.setText(product.getPrice() + &quot;元&quot;);</div><div class="line"></div><div class="line">			return convertView;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// ListView的Item组件类</div><div class="line">	private class ListViewItemHolder &#123;</div><div class="line">		ImageView imgIv;</div><div class="line">		TextView nameTv;</div><div class="line">		TextView priceTv;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码过长，我就不一一说明了，并且代码中关键点我也写了注释，想了解的可以看一下，在这里我重点说一下源码中 Picasso.with(MainActivity.this).setIndicatorsEnabled(true);这句代码，这句代码是用来在图片右上角来显示标志一个三角标志的，有人会问这个标志有什么用途了？这个标志充分体验上Google程序员高大上的地方（代码给使用者良好的体验），这里的标志用来说明图片是从网络，本地，或是内存中加载出来的，形象的来说明图片的缓存机制！红色三角表示从网络上下载显示的，黄色三角表求图片是从本地文件硬盘读取的，若三色为绿色表求图片是直接从内存缓存中加载的，这也更加形象的说明了Picasso的三级图片缓存机制！ </p>
<p>注：这个三角标志可以从上面的效果图片中清晰的看出来</p>
<p>细心的读者可能发现上面Picasso.with(MainActivity.this).load(product.getImgUrl()).transform(new CircleTransform()).into(item.imgIv);代码调用了transform(new CircleTransform())这个方法，这个在这里起什么作用了？Picasso这个库支持进行图片变换，这里的作用就是把图片变换成圆形显示！</p>
<p>进行图片变换为圆形的转换器代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">package com.shen.picasso;</div><div class="line"></div><div class="line">import android.graphics.Bitmap;</div><div class="line">import android.graphics.BitmapShader;</div><div class="line">import android.graphics.Canvas;</div><div class="line">import android.graphics.Paint;</div><div class="line"></div><div class="line">import com.squareup.picasso.Transformation;</div><div class="line"></div><div class="line">public class CircleTransform implements Transformation &#123;</div><div class="line">	@Override</div><div class="line">	public Bitmap transform(Bitmap source) &#123;</div><div class="line">		int size = Math.min(source.getWidth(), source.getHeight());</div><div class="line"></div><div class="line">		int x = (source.getWidth() - size) / 2;</div><div class="line">		int y = (source.getHeight() - size) / 2;</div><div class="line"></div><div class="line">		Bitmap squaredBitmap = Bitmap.createBitmap(source, x, y, size, size);</div><div class="line">		if (squaredBitmap != source) &#123;</div><div class="line">			source.recycle();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Bitmap bitmap = Bitmap.createBitmap(size, size, source.getConfig());</div><div class="line"></div><div class="line">		Canvas canvas = new Canvas(bitmap);</div><div class="line">		Paint paint = new Paint();</div><div class="line">		BitmapShader shader = new BitmapShader(squaredBitmap,</div><div class="line">				BitmapShader.TileMode.CLAMP, BitmapShader.TileMode.CLAMP);</div><div class="line">		paint.setShader(shader);</div><div class="line">		paint.setAntiAlias(true);</div><div class="line"></div><div class="line">		float r = size / 2f;</div><div class="line">		canvas.drawCircle(r, r, r, paint);</div><div class="line"></div><div class="line">		squaredBitmap.recycle();</div><div class="line">		return bitmap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public String key() &#123;</div><div class="line">		return &quot;circle&quot;;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Listview中填充的数据对象类如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">package com.shen.picasso;</div><div class="line"></div><div class="line">//表示菜类（经过烹调的蔬菜、蛋品、肉类等）</div><div class="line">public class Product &#123;</div><div class="line"></div><div class="line">	private String imgUrl; // 图片地址</div><div class="line">	private String name; // 菜名</div><div class="line">	private String price; // 菜价</div><div class="line">	</div><div class="line">	public Product(String imgUrl, String name, String price) &#123;</div><div class="line">		this.imgUrl = imgUrl;</div><div class="line">		this.name = name;</div><div class="line">		this.price = price;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public String getImgUrl() &#123;</div><div class="line">		return imgUrl;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setImgUrl(String imgUrl) &#123;</div><div class="line">		this.imgUrl = imgUrl;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public String getName() &#123;</div><div class="line">		return name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setName(String name) &#123;</div><div class="line">		this.name = name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public String getPrice() &#123;</div><div class="line">		return price;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setPrice(String price) &#123;</div><div class="line">		this.price = price;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>picasso是Square公司开源的一个Android图形缓存库，<a href="http://square.github.io/picasso/" target="_blank" rel="external">地址</a>，可以实现图片下载和缓存功能。仅仅只需要一行代码就能完全实现图片的异步加载!</p>
<p>如果项目中使用了OkHttp库的话，默认会使用OkHttp来下载图片。否则使用HttpUrlConnection来下载图片。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">static Downloader createDefaultDownloader(Context context) &#123;</div><div class="line">  try &#123;</div><div class="line">    Class.forName(&quot;com.squareup.okhttp.OkHttpClient&quot;);</div><div class="line">    return OkHttpLoaderCreator.create(context);</div><div class="line">  &#125; catch (ClassNotFoundException ignored) &#123;</div><div class="line">  &#125;</div><div class="line">  return new UrlConnectionDownloader(context);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Picasso的一些基本策略缓存策略MemoryCache+DiskCache+Net<br>1.MemoryCache采用的是Lru策略，持有一定数量处理过的图(譬如经过resize/rotate处理，可直接设置到view中)。<br>2.DiskCache是网络图片在本地的缓存，缓存的是原图，可能需要经过处理才能设置到view中。<br>3.Net是图片服务器，当MemoryCache和DiskCache均取不到图片时，网络拉取，成本最高。</p>
<p>Picasso最大缓存为50MB,最小的缓存为：5MB<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">private static final int MIN_DISK_CACHE_SIZE = 5 * 1024 * 1024; // 5MB</div><div class="line">private static final int MAX_DISK_CACHE_SIZE = 50 * 1024 * 1024; // 50MB</div></pre></td></tr></table></figure></p>
<p>Picasso进行缓存：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">try &#123;</div><div class="line">           File httpCacheDir = new File(context.getCacheDir(), &quot;http&quot;);</div><div class="line">           long httpCacheSize = 10 * 1024 * 1024; // 10 MiB</div><div class="line">          Class.forName(&quot;android.net.http.HttpResponseCache&quot;)</div><div class="line">                 .getMethod(&quot;install&quot;, File.class, long.class)</div><div class="line">                 .invoke(null, httpCacheDir, httpCacheSize);</div><div class="line">     &#125; catch (Exception httpResponseCacheNotAvailable) &#123;</div><div class="line">     &#125;&#125;</div></pre></td></tr></table></figure></p>
<p>源码下载地址：</p>
<p><a href="https://github.com/shenjianli/PicassoTest" target="_blank" rel="external">PicassoTest 源码</a></p>
<p><a href="http://square.github.io/picasso/" target="_blank" rel="external">官方地址</a><br><a href="http://square.github.io/picasso/2.x/picasso/" target="_blank" rel="external">Picasso Api</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Picasso/">Picasso</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-the-plan-of-cache" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/27/the-plan-of-cache/" class="article-date">
  	<time datetime="2016-05-27T02:14:26.000Z" itemprop="datePublished">2016-05-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/27/the-plan-of-cache/">缓存机制</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Android-客户端缓存机制"><a href="#Android-客户端缓存机制" class="headerlink" title="Android 客户端缓存机制"></a>Android 客户端缓存机制</h2><p>Android客户端的缓存机制能很好的提高客户端的显示速度，节省不必要的流量请求，为用户提供良好的体验等优点。虽然Android缓存有上述所述的好处，但并不是所有的网络请求，所有的业务逻辑都适合使用缓存机制！如，电商中常有的秒杀功能要求数据实时性特别强，几毫秒的缓存延迟都会严重影响数据的同步，给用户错误的库存及倒计时的体验！那什么情况下适合运用缓存机制了，其实也好理解，就是对于数据实时性要求不高，对数据买保鲜性要求较低的业务请求，我们可以考虑使用缓存机制来进行数据缓存，充分利用缓存带给我们的好处！</p>
<p>下面争对我开发的电商Android客户端的业务，来说明一下请求是否适合使用缓存：</p>
<table>
<thead>
<tr>
<th>业务功能</th>
<th>是否适用缓存</th>
<th>缓存内容</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>轮播图</td>
<td>是</td>
<td>Json数据</td>
<td>数据不会经常改动</td>
</tr>
<tr>
<td>快速入口</td>
<td>是</td>
<td>Json数据</td>
<td>数据及跳转的地址不会经常变动</td>
</tr>
<tr>
<td>秒杀</td>
<td>否</td>
<td>–</td>
<td>时实性较强，需要与后台数据保持高度的实时性</td>
</tr>
<tr>
<td>专题</td>
<td>是</td>
<td>Json数据</td>
<td>实时性要求不高</td>
</tr>
<tr>
<td>行业精选</td>
<td>是</td>
<td>Json数据</td>
<td>实时性要求不高</td>
</tr>
<tr>
<td>大数据推荐</td>
<td>否</td>
<td>–</td>
<td>实时高，根据用户的浏览历史推出不同的商品</td>
</tr>
<tr>
<td>普通商品详情</td>
<td>否</td>
<td>–</td>
<td>现有基础上不能缓存，若是能把请求进行细分，可以考虑部分缓存</td>
</tr>
<tr>
<td>秒杀商品详情</td>
<td>否</td>
<td>–</td>
<td>实时性较强，需要与后台数据保持高度的实时性</td>
</tr>
<tr>
<td>显示广告</td>
<td>是</td>
<td>Json数据</td>
<td>这个修改不会过于频繁，若要修改频繁可以设置一个较短的失效时间</td>
</tr>
</tbody>
</table>
<p>##缓存方案##</p>
<p>###缓存方案的流程图如下所示：###<br><img src="/image/cache.jpg" alt="cache uml"></p>
<p>###缓存方案实现简单介绍：###<br>（1）在手机内存中进行缓存，初步设想为Map结构，缓存是传入关键字（key）和要缓存的数据（例如为Object），使用缓存时直接根据关键字（key）来获取缓存中的数据（Object），再根据Object中的属性更新界面显示。</p>
<p>（2）若在（1）中取出的Object为空，说明内存中没有缓存key所对应的数据对象，我可以从二级缓存数据库中进行读取，并把缓存更新内存缓存中。</p>
<p>（3）若在（2）中也没有读取到Key所对应的数据，则发送网络请求从后台服务器端获取数据，更新界面及手机内存缓存和数据库缓存，为下次使用缓存提供数据支撑！</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cache/">cache</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 申建利
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>